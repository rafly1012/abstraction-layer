<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Image Search Abstraction</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, Arial;
        background: #0b1220;
        color: #e6eef8;
        margin: 0;
        padding: 20px;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      input[type="text"] {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        min-width: 280px;
        font-size: 1rem;
        background: #1e293b;
        color: #f1f5f9;
        outline: none;
      }
      button {
        padding: 10px 16px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }
      .results {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }
      .card {
        background: #1e293b;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
      }
      .card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }
      .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
      }
      .meta {
        padding: 10px;
        font-size: 0.9rem;
        color: #cbd5e1;
      }
      .meta strong {
        color: #f1f5f9;
        display: block;
        margin-bottom: 4px;
      }
      .meta a {
        color: #60a5fa;
        text-decoration: none;
        font-size: 0.85rem;
      }
      .meta a:hover {
        text-decoration: underline;
      }
      .recent {
        margin-top: 18px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .recent button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #cbd5e1;
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.85rem;
      }
      .recent button:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .pagination {
        margin-top: 20px;
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
      }
      .skeleton {
        background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 12px;
        height: 200px;
      }
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h2 style="margin:0;">üîé Image Search</h2>
        <input id="q" type="text" placeholder="Search images (e.g. cats funny)" />
        <button id="searchBtn">Search</button>
        <div style="margin-left: auto" id="status"></div>
      </header>

      <div class="recent" id="recent"></div>

      <div class="results" id="results"></div>

      <div class="pagination" id="pagination" style="display: none">
        <button id="prevBtn">‚¨Ö Prev</button>
        <span id="pageInfo"></span>
        <button id="nextBtn">Next ‚û°</button>
      </div>

      <footer style="margin-top: 24px; color: #94a3b8; font-size: 0.85rem;">
        Powered by Unsplash API ‚Äî Recent searches are stored server-side.
      </footer>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const qInput = document.getElementById("q");
      const searchBtn = document.getElementById("searchBtn");
      const resultsEl = document.getElementById("results");
      const recentEl = document.getElementById("recent");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const pageInfo = document.getElementById("pageInfo");
      const pagination = document.getElementById("pagination");

      let currentQuery = "";
      let currentPage = 1;
      const perPage = 12;

      async function loadRecent() {
        try {
          const r = await fetch("/api/recent");
          const items = await r.json();
          recentEl.innerHTML =
            items.length > 0
              ? items
                  .map(
                    (it) => `<button data-term="${encodeURIComponent(it.term)}">${it.term}</button>`
                  )
                  .join("")
              : '<span style="color:#94a3b8">No recent searches</span>';
          recentEl.querySelectorAll("button").forEach((btn) => {
            btn.addEventListener("click", () => {
              qInput.value = decodeURIComponent(btn.dataset.term);
              doSearch(1);
            });
          });
        } catch (err) {
          console.error("Failed to load recent searches", err);
        }
      }

      async function doSearch(page = 1) {
        const q = qInput.value.trim();
        if (!q) return;
        currentQuery = q;
        currentPage = page;

        statusEl.textContent = "Searching...";
        resultsEl.innerHTML = Array(perPage)
          .fill(0)
          .map(() => `<div class="skeleton"></div>`)
          .join("");
        pagination.style.display = "none";

        try {
          const url = `/api/imagesearch/${encodeURIComponent(q)}?page=${page}&per_page=${perPage}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Search failed");
          const results = await res.json();

          renderResults(results);
          updatePagination();
          statusEl.textContent = `Showing page ${page} ‚Äî ${results.length} results`;
          loadRecent();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Search failed";
          resultsEl.innerHTML = '<div style="color:#94a3b8">‚ö†Ô∏è Failed to load results</div>';
        }
      }

      function renderResults(list) {
        if (!list || list.length === 0) {
          resultsEl.innerHTML = '<div style="color:#94a3b8">No results found</div>';
          return;
        }
        resultsEl.innerHTML = list
          .map(
            (it) => `
              <div class="card">
                <a href="${it.pageUrl}" target="_blank" rel="noopener noreferrer">
                  <img src="${it.imageUrl}" alt="${escapeHtml(it.description)}" />
                </a>
                <div class="meta">
                  <strong>${escapeHtml(it.description)}</strong>
                  <a href="${it.photographerProfile}" target="_blank">${escapeHtml(it.photographer)}</a>
                </div>
              </div>
            `
          )
          .join("");
      }

      function updatePagination() {
        pagination.style.display = "flex";
        pageInfo.textContent = `Page ${currentPage}`;
        prevBtn.disabled = currentPage <= 1;
      }

      searchBtn.addEventListener("click", () => doSearch(1));
      qInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch(1);
      });
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) doSearch(currentPage - 1);
      });
      nextBtn.addEventListener("click", () => doSearch(currentPage + 1));

      function escapeHtml(str) {
        return (str || "").replace(/[&<>"']/g, (c) =>
          ({
            "&": "&amp;",
            "<": "<",
            ">": ">",
            '"': "&quot;",
            "'": "&#39;",
          }[c])
        );
      }

      loadRecent();
    </script>
  </body>
</html>
